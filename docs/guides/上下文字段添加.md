   ğŸ“ è¯¦ç»†æŒ‡å—ï¼šåœ¨ Memory Metadata ä¸­æ·»åŠ æ–°å­—æ®µ

   1. ç†è§£ç°æœ‰ Message ç»“æ„

     @dataclass
     class Message:
         role: str                                    # "user", "assistant", "system", "tool"
         content: str                                 # æ¶ˆæ¯å†…å®¹
         timestamp: datetime = field(default_factory=datetime.now)
         metadata: Dict[str, Any] = field(default_factory=dict)  # â† è¿™é‡Œå¯ä»¥æ‰©å±•

   metadata å°±æ˜¯ä½ æ·»åŠ è‡ªå®šä¹‰å­—æ®µçš„åœ°æ–¹ã€‚

   ----------------------------------------------------------------------------------------------------------------------

   2. æ·»åŠ æ–°å­—æ®µçš„ä¸‰ç§æ–¹æ³•

   æ–¹æ³• 1ï¼šé€šè¿‡ metadata å‚æ•°æ·»åŠ ï¼ˆæ¨èï¼‰

     from src.core.memory import get_memory
     
     memory = get_memory()

     # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼Œå¹¶åŒ…å«é¢å¤–ä¿¡æ¯
     memory.add_user_message(
         content="è¯·åˆ†æè¿™äº›æ–‡ä»¶",
         metadata={
             "files": ["data.csv", "config.json"],           # æ–°å­—æ®µï¼šæ–‡ä»¶åˆ—è¡¨
             "workspace": "/home/user/project",             # æ–°å­—æ®µï¼šå·¥ä½œç›®å½•
             "user_id": "user_123",                         # æ–°å­—æ®µï¼šç”¨æˆ·ID
             "source": "api",                               # æ–°å­—æ®µï¼šä¿¡æ¯æ¥æº
             "tags": ["urgent", "data-analysis"]            # æ–°å­—æ®µï¼šæ ‡ç­¾
         }
     )

   æ–¹æ³• 2ï¼šä¿®æ”¹æ¶ˆæ¯åæ·»åŠ  metadata

     memory.add_user_message("åˆ†ææŠ¥å‘Š")
     # è·å–æœ€åä¸€æ¡æ¶ˆæ¯å¹¶ä¿®æ”¹å…¶ metadata
     last_message = memory.messages[-1]
     last_message.metadata["files"] = ["report.pdf"]
     last_message.metadata["priority"] = "high"

   æ–¹æ³• 3ï¼šä¸ºåŠ©æ‰‹æ¶ˆæ¯æ·»åŠ  metadata

     memory.add_assistant_message(
         content="æˆ‘å·²å¼€å§‹åˆ†æ",
         metadata={
             "model": "gpt-4",
             "temperature": 0.7,
             "tokens_used": 150,
             "execution_time": 2.5
         }
     )

   ----------------------------------------------------------------------------------------------------------------------  

   3. ä¸ºå·¥å…·æ¶ˆæ¯æ·»åŠ  metadataï¼ˆé‡è¦ï¼‰

     memory.add_tool_message(
         content="åˆ†æå®Œæˆï¼šå…±100è¡Œæ•°æ®",
         tool_name="csv_analyzer",
         metadata={
             "tool_name": "csv_analyzer",                # å·¥å…·åç§°
             "tool_call_id": "call_csv_123",            # å·¥å…·è°ƒç”¨IDï¼ˆKimi APIéœ€è¦ï¼‰
             "execution_time": 1.23,                    # æ‰§è¡Œæ—¶é—´
             "rows_processed": 100,                     # å¤„ç†è¡Œæ•°
             "status": "success"                        # æ‰§è¡ŒçŠ¶æ€
         }
     )

   ----------------------------------------------------------------------------------------------------------------------  

   4. æ£€ç´¢å’Œè®¿é—® metadata ä¸­çš„æ•°æ®

     # è·å–æ‰€æœ‰æ¶ˆæ¯
     messages = memory.get_messages()

     # éå†æ¶ˆæ¯å¹¶è®¿é—® metadata
     for msg in messages:
         if msg.metadata.get("files"):
             print(f"æ¶ˆæ¯æ¶‰åŠçš„æ–‡ä»¶: {msg.metadata['files']}")

         if "execution_time" in msg.metadata:
             print(f"æ‰§è¡Œè€—æ—¶: {msg.metadata['execution_time']}s")

     # è·å–ç‰¹å®šæ¶ˆæ¯çš„ metadata
     last_msg = memory.messages[-1]
     workspace = last_msg.metadata.get("workspace", "/default")
     priority = last_msg.metadata.get("priority", "normal")

   ----------------------------------------------------------------------------------------------------------------------  

   5. æ¨èçš„ Metadata å­—æ®µè§„èŒƒ

   åˆ›å»ºä¸€å¥—æ ‡å‡†å­—æ®µï¼Œä¾¿äºç»Ÿä¸€ä½¿ç”¨ï¼š

     # ç”¨æˆ·æ¶ˆæ¯æ¨èå­—æ®µ
     USER_MESSAGE_FIELDS = {
         "files": List[str],              # æ¶‰åŠçš„æ–‡ä»¶
         "workspace": str,                # å·¥ä½œç›®å½•
         "user_id": str,                  # ç”¨æˆ·æ ‡è¯†
         "timestamp_ms": int,             # æ¯«ç§’çº§æ—¶é—´æˆ³
         "source": str,                   # æ¥æºï¼ˆapi/cli/webï¼‰
         "tags": List[str],               # åˆ†ç±»æ ‡ç­¾
         "priority": str,                 # ä¼˜å…ˆçº§
     }

     # åŠ©æ‰‹æ¶ˆæ¯æ¨èå­—æ®µ
     ASSISTANT_MESSAGE_FIELDS = {
         "model": str,                    # ä½¿ç”¨çš„æ¨¡å‹
         "temperature": float,            # æ¸©åº¦å‚æ•°
         "tokens_used": int,              # tokenæ¶ˆè€—
         "execution_time": float,         # æ‰§è¡Œæ—¶é—´
         "tool_calls": List[Dict],        # å·¥å…·è°ƒç”¨ä¿¡æ¯
     }

     # å·¥å…·æ¶ˆæ¯æ¨èå­—æ®µ
     TOOL_MESSAGE_FIELDS = {
         "tool_name": str,                # å·¥å…·åç§°
         "tool_call_id": str,             # è°ƒç”¨IDï¼ˆå¿…éœ€ï¼‰
         "execution_time": float,         # æ‰§è¡Œè€—æ—¶
         "status": str,                   # æ‰§è¡ŒçŠ¶æ€
         "error_message": str,            # é”™è¯¯ä¿¡æ¯
         "result_size": int,              # ç»“æœå¤§å°
     }

   ----------------------------------------------------------------------------------------------------------------------  

   6. å®æˆ˜ç¤ºä¾‹ï¼šå®Œæ•´çš„ Agent é›†æˆ

     from src import BaseAgent, get_memory
     from datetime import datetime

     # åˆå§‹åŒ–
     agent = BaseAgent()
     memory = agent.memory

     # æ·»åŠ å¸¦æ–‡ä»¶ä¿¡æ¯çš„ç”¨æˆ·æ¶ˆæ¯
     memory.add_user_message(
         content="åˆ†æ data.csv å’Œ report.xlsx",
         metadata={
             "files": ["data.csv", "report.xlsx"],
             "workspace": "/project/analysis",
             "user_id": "alice_001",
             "timestamp_ms": int(datetime.now().timestamp() * 1000),
             "source": "web_api",
             "tags": ["urgent", "quarterly_report"],
             "priority": "high"
         }
     )

     # è¿è¡Œ Agent
     response = agent.run("åˆ†æè¿™äº›æ–‡ä»¶")

     # éå†æ‰€æœ‰æ¶ˆæ¯å¹¶æå–æ–‡ä»¶ä¿¡æ¯
     print("\n=== æ¶ˆæ¯å†å²ä¸­çš„æ–‡ä»¶ ===")
     for i, msg in enumerate(memory.get_messages()):
         if msg.metadata.get("files"):
             print(f"æ¶ˆæ¯ {i}: {msg.role}")
             print(f"  æ–‡ä»¶: {msg.metadata['files']}")
             print(f"  ä¼˜å…ˆçº§: {msg.metadata.get('priority', 'normal')}")
             print(f"  æ ‡ç­¾: {msg.metadata.get('tags', [])}")

   ----------------------------------------------------------------------------------------------------------------------  

   7. åœ¨ OpenAI æ ¼å¼ä¸­ä¿ç•™ Metadata

     def to_openai_format_with_metadata(self) -> Dict[str, str]:
         """è½¬æ¢ä¸ºOpenAIæ ¼å¼ï¼ŒåŒæ—¶ä¿ç•™metadata"""
         msg_dict = self.to_openai_format()

         # æ·»åŠ è‡ªå®šä¹‰å…ƒæ•°æ®ï¼ˆOpenAIä¼šå¿½ç•¥ï¼Œä½†æœ¬åœ°å¯ä½¿ç”¨ï¼‰
         if self.metadata:
             msg_dict["_metadata"] = self.metadata

         return msg_dict

     # ä½¿ç”¨
     msg = memory.messages[-1]
     msg_with_meta = msg.to_openai_format_with_metadata()
     print(msg_with_meta["_metadata"])  # è®¿é—®æœ¬åœ° metadata

   ----------------------------------------------------------------------------------------------------------------------  

   âœ… æ€»ç»“

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æ“ä½œ              â”‚ ä»£ç ç¤ºä¾‹                                         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ æ·»åŠ  metadata     â”‚ memory.add_user_message(content, metadata={...}) â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ è®¿é—® metadata     â”‚ msg.metadata.get("key", default)                 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ æ£€æŸ¥æ˜¯å¦æœ‰æŸå­—æ®µ  â”‚ if "files" in msg.metadata:                      â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ éå†æ‰€æœ‰ metadata â”‚ for key, value in msg.metadata.items():          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ ä¿®æ”¹å·²æœ‰æ¶ˆæ¯      â”‚ msg.metadata["new_key"] = value                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜